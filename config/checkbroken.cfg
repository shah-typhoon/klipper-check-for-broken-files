[gcode_shell_command check_broken]
command: /usr/bin/python3 /root/printer_data/scripts/klipper.py
timeout: 2.
verbose: True

[gcode_macro CHECK_BROKEN]
gcode:
    {% if printer.idle_timeout.state != "Printing" %}
        {action_raise_error("Abnormal script launch.")}
    {% endif %}

    PAUSE
    {% set fname = print_stats.filename|default("") %}
    {% if fname == "" %}
        RESPOND TYPE=error MSG="Не указан файл для печати."
    {% else %}
        RUN_SHELL_COMMAND CMD=check_broken PARAMS={fname}
    {% endif %}
